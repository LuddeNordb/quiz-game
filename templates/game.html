<!DOCTYPE html>
<html lang="en">



<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description"
        content="På spåret quiz">

    <meta name="keywords"
        content="Quiz Game, På spåret">

    <meta name="author" content="LN">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Open Graph / Facebook -->

    <meta property="og:type" content="website">

    <meta property="og:url" content="https:/you-website-link/">

    <meta property="og:title" content="På spåret">

    <meta property="og:description" content="På spåret quiz">

    <meta property="og:image" content="https:/you-website-link/static/img/logo.webp">



    <!-- Twitter -->

    <meta property="twitter:card" content="summary_large_image">

    <meta property="twitter:url" content="https:/you-website-link/">

    <meta property="twitter:title" content="På spåret">

    <meta property="twitter:description"
        content="På spåret">

    <meta property="twitter:image" content="https:/you-website-link/static/img/logo.webp">



    <meta name="robots" content="index, follow">

    <meta name="twitter:card" content="summary_large_image">

    <meta name="twitter:title" content="På spåret">

    <meta name="twitter:description"
        content="På spåret">

    <meta name="twitter:image" content="{{ url_for('static', filename='fav/logo.png') }}">

    <link rel="icon" href="{{ url_for('static', filename='fav/favicon.ico') }}" type="image/x-icon">



    <title>På spåret</title>



    <!-- Bootstrap CSS -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">



    <!-- Socket.io Script -->

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.min.js"></script>



    <!-- Bootstrap Bundle JS -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>



    <!-- Favicon -->

    <link rel="icon" href="{{ url_for('static', filename='fav/favicon.ico') }}" type="image/x-icon">



    <!-- Custom CSS for Design -->

    <style>
        .swal2-html-container {

            color: white !important;

        }



        .swal2-title {

            color: white !important;

        }



        .avatar-selection img {

            width: 50px;

            height: 50px;

            margin: 5px;

            border-radius: 50%;

            cursor: pointer;

        }


        .correct-answer {
            box-shadow: 0px 4px 10px #7efc9bf7,
                0px -4px 10px #7efc9bf7,
                inset 4px 0px 10px #7efc9bf7,
                inset -4px 0px 10px #7efc9bf7;
            border-radius: 10px;
            /* Adjust the value as needed for the desired roundness */
        }



        .avatar-selection img.selected {

            border: 3px solid #ffa9fa;

        }



        .card {

            color: #9C9C9C;

            background-color: #2F2F2F;

            border: 0px solid rgb(248, 7, 7);

            border-radius: 10px;

            overflow: hidden;

            margin: 0.25em;

        }

        .btn-custom {
        display: inline-block;
        outline: 0;
        border: 0;
        font-size: 20px;
        font-weight: 500;
        color: #fff;
        cursor: pointer;
        background-image: linear-gradient(to right,#e052a0,#f15c41)!important;
        border-radius: 3px;
        padding: 16px 18px 15px;
        white-space: nowrap;
        }

        .btn-custom:hover {
            background-color: #e6375a;
            background-image: none!important;
        }

        .btn-logoout {
            display: inline-block;
            outline: 0;
            border:0;
            cursor: pointer;
            text-decoration: none;
            position: relative;
            color: rgb(246, 84, 174);
            background: #fff;
            line-height: 30px;
            border-radius: 40px;
            width: 150px;
            padding: 5px;
            font-size: 17px;
            font-weight: 600;
            box-shadow: rgb(255, 198, 0) -2px -2px 0px 2px, rgb(246, 84, 174) 0px 0px 0px 4px, rgba(0, 0, 0, 0.05) 0px 0px 2px 7px;
            transition: all 0.2s;
        }
        .btn-logoout:hover{
            box-shadow: rgb(246, 84, 174) -2px -2px 0px 2px, rgb(255, 198, 0) 0px 0px 0px 4px, rgba(0, 0, 0, 0.05) 0px 0px 2px 7px;
            transform: scale(1.01);
        }
        .alert-info {
        --bs-alert-bg: linear-gradient(to right,#e052a0,#f15c41)!important;
        --bs-alert-border-color: rgb(246, 84, 174); 
        --bs-alert-color: rgb(255, 255, 255);   /* Change text color */
        border-width: 3px;
        }
                    

                



        .form-control {

            color: #9C9C9C !important;

            background-color: #ffffff;

            border: 1px solid transparent;

        }



        .form-control::placeholder {

            color: #9C9C9C !important;

            background-color: #ffffff;

            border: 1px solid transparent;

        }



        .form-control:focus {

            color: #FFFFFF;

            background-color: #e7e6e6;

        }



        .form-control:hover {

            background-color: #e9e9e9;

        }



        .card-body {

            display: flex;

            align-items: center;

            gap: 15px;

            padding: 15px;

            background-color: transparent;

        }



        body {

            min-height: 100vh;
            margin: 0;

            background-image: url('../static/img/bg.webp');

            background-size: cover;
                
            /* Keeps the image from scrolling away when you move down the page */
            background-attachment: fixed;
            
            background-position: center center;
            background-repeat: no-repeat;
            
            /* Overlay color */
            background-color: rgba(0, 0, 0, 0.175);

        }



        .card-body img {

            margin-right: 15px;

        }



        .text-color {

            color: white;

        }



        .vote-btn {

            margin-left: auto;

        }

        .hard-shadow {
    /* Syntax: h-shadow v-shadow blur-radius color */
    text-shadow: 2px 2px 0px #00000052;
  }
    </style>

</head>





<body>



    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-5" style="position: relative;">
            <!-- Empty div for left alignment -->
            <div></div>

            <!-- Logo in the center -->
            <div class="text-center logo-container" style="position: absolute; left: 50%; transform: translateX(-50%);">
                <img src="../static/img/logo.webp" alt="Admin Logo"
                    style="width: 400px; max-width: 100%; height: auto;">
            </div>

            <!-- Username, Avatar, and Logout on the right -->
            <div class="text-center">
                <h2>
                    <label for="userName" class="form-label text-color">
                        {% if session['username'] %}
                        <img src="{{ session['avatar'] }}" alt="Avatar" class="avatar"
                            style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
                        {{ session['username'] }}
                        {% else %}
                        Guest
                        {% endif %}
                    </label>
                </h2>

            </div>
        </div>


        <div class="row mb-3">

        </div>

        <div id="image-gallery" class="row g-2 mb-3 justify-content-center"></div>

        <div class="d-flex justify-content-center align-items-center">
            <h2 id="question-text" class="text-white hard-shadow" style="
                       border-radius: 30px; 
                       padding: 15px; 
                       max-width: 80%; 
                       text-align: center; ">
                Laddar frågor...
            </h2>
        </div>


        <div id="map-container" style="display: none; height: 400px; width: 100%; border-radius: 10px; margin-bottom: 20px;"></div>

        <div class="container mt-5">

            <div class="row justify-content-center">

                <div class="col-md-12">

                    <div class="mb-3">
                                    
                        <div id="answerInputsContainer">
                            <input type="text" class="form-control form-control-lg part-input" id="answerInput" placeholder="Skriv in dina svar" />
                        </div>
                    
                        <div id="map-container" style="display: none; height: 400px; width: 100%; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444;"></div>
                    </div>

                    <button id="submitAnswer" class="btn btn-lg btn-custom w-100">Lås in</button>

                </div>

            </div>

        </div>

        <hr>

        <div id="answers-list">

        </div>

        <div class="container mt-4">

            <h2 class="text-center text-light hard-shadow mb-4">Poängställning</h2>

            <div id="users" class="row justify-content-center"></div>

        </div>

        <div id="reveal-button" class="mt-3">

            <button id="revealVotes" class="btn btn-success" style="display: none;">Reveal Votes</button>

        </div>

    </div>



    <script>

        var socket = io.connect('http://' + document.domain + ':' + location.port);

        var selectedAvatar = "{{ avatar }}";

        var userName = "{{ username }}"; // Get the username from the Flask session

        var userId = "{{ username }}"; // Get the username from the Flask session

        let currentQuestionId = 1;

        let playerMap;

        let playerMarker;

        let currentQuestionType = 'standard'; 



        document.addEventListener("DOMContentLoaded", function () {

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));

            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {

                return new bootstrap.Tooltip(tooltipTriggerEl);

            });

        });



        document.querySelectorAll('#avatarSelection img').forEach(function (img) {

            img.addEventListener('click', function () {

                document.querySelectorAll('#avatarSelection img').forEach(function (img) {

                    img.classList.remove('selected');

                });

                img.classList.add('selected');

                selectedAvatar = img.getAttribute('data-avatar');

            });

        });



        document.getElementById('revealVotes').addEventListener('click', function () {

            fetch('/reveal_votes_admin', {

                method: 'POST',

            }).then(response => response.json())

                .then(data => {

                    console.log('Votes revealed', data);

                    loadAnswers();

                });

        });

        function renderImages(images) {
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = ''; // Clear existing
            
            if (images && images.length > 0) {
                images.forEach(imgName => {
                    const col = document.createElement('div');
                    // Adjust column size based on number of images
                    col.className = images.length === 1 ? 'col-12' : 'col-6 col-md-4';
                    
                    col.innerHTML = `
                        <div class="card bg-dark border-secondary">
                            <img src="/static/images/${imgName}" 
                                class="card-img-top img-fluid rounded shadow-sm" 
                                style="max-height: 300px; object-fit: contain; padding: 5px;"
                                onclick="window.open(this.src, '_blank')"
                                alt="Question Image">
                        </div>`;
                    gallery.appendChild(col);
                });
                gallery.style.display = 'flex';
            } else {
                gallery.style.display = 'none';
            }
        }

        function fetchUsers() {

            fetch('/get_users') // Adjust this endpoint to match your backend route

                .then(response => response.json())

                .then(data => {

                    const usersContainer = document.getElementById('users');

                    usersContainer.innerHTML = ''; // Clear existing users



                    data.users.forEach(user => {

                        const userCard = document.createElement('div');

                        userCard.classList.add('col-sm-6', 'col-md-2', 'col-lg-2', 'mb-4');



                        userCard.innerHTML = `

                    <div class="card text-center shadow-sm">

                        <div class="card-body">

                            <img src="${user.avatar}" alt="${user.username}'s avatar" 

                                 class="rounded-circle mb-3" style="width: 50px; height: 50px;">

                            <p class="card-text"><strong>Poäng:</strong> ${user.score}</p>

                        </div>

                    </div>

                `;

                        usersContainer.appendChild(userCard);

                    });

                })

                .catch(error => console.error('Error fetching users:', error));

        }

        function initMap() {
            if (playerMap) {
                // RE-ENABLE all interactions for the new round
                playerMap.dragging.enable();
                playerMap.touchZoom.enable();
                playerMap.doubleClickZoom.enable();
                playerMap.scrollWheelZoom.enable();
                if (playerMap.tap) playerMap.tap.enable(); // For mobile support
                
                playerMap.invalidateSize();
                return;
            }
            
            playerMap = L.map('map-container').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(playerMap);

            playerMap.on('click', function(e) {
                if (document.getElementById('submitAnswer').disabled) return;

                if (playerMarker) {
                    playerMarker.setLatLng(e.latlng);
                } else {
                    playerMarker = L.marker(e.latlng).addTo(playerMap);
                }
            });
        }

        function loadAnswers() {

            fetch('/get_game_state')

                .then(response => response.json())
                .then(data => {
                    const answersList = document.getElementById('answers-list');
                    answersList.innerHTML = '';

                    const rowDiv = document.createElement('div');

                    rowDiv.classList.add('row');



                    let sortedAnswers = [...data.answers];

                    sortedAnswers.sort((a, b) => b.random_num - a.random_num);



                    sortedAnswers.forEach(answer => {

                        var answerDiv = document.createElement('div');

                        answerDiv.classList.add('col-md-12', 'card', 'mt-3');

                        let displayHeader = "";
                        if (answer.potential_points !== undefined && answer.potential_points > 0) {
                            displayHeader = `<strong>${answer.potential_points}</strong>: ${answer.username}`;
                        } else {
                            displayHeader = `${answer.username}`;
                        }

                        answerDiv.innerHTML = `
                            <div class="card text-center">
                                <div class="card-body">
                                    <img src="${answer.avatar}" alt="${answer.username}'s Avatar" class="rounded-circle answer-avatar" width="50" style="display: none;" data-bs-toggle="tooltip" title="${answer.username}">
                                    <p class="card-text answer-text">
                                        <strong class="answer-name">${displayHeader}</strong> 
                                        ${Array.isArray(answer.text) ? answer.text.join(', ') : answer.text}
                                    </p>
                                    <div class="votes" id="votes-${answer.id}" style="display: ${votesRevealed ? 'block' : 'none'};">Votes: ${answer.votes.join(', ')}</div>
                                </div>                    
                            </div>
                        `;

                        rowDiv.appendChild(answerDiv);

                    });



                    answersList.appendChild(rowDiv);



                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));

                    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {

                        return new bootstrap.Tooltip(tooltipTriggerEl);

                    });



                    if (data.reveal) {

                        sortedAnswers.forEach(answer => {

                            const voteDiv = document.getElementById(`votes-${answer.id}`);

                            voteDiv.innerHTML = `Votes: ${answer.votes.join(', ')}`;

                            voteDiv.style.display = 'block';



                            const answerCard = document.querySelector(`[data-answer-id="${answer.id}"]`)

                                .closest('.card');

                            const answerInfo = answerCard.querySelector('.answer-info');

                            answerInfo.style.display = 'block';

                        });



                        const voteButtons = document.querySelectorAll('.vote-btn');

                        voteButtons.forEach(button => button.disabled = true);

                    }



                    document.querySelectorAll('.vote-btn').forEach(function (button) {

                        button.addEventListener('click', function () {

                            if (!userName) {

                                Swal.fire({

                                    title: "Oops!",

                                    text: "Please enter your name before voting!",

                                    icon: "warning"

                                });

                                return;

                            }

                            if (!selectedAvatar) {

                                Swal.fire({

                                    title: "Oops!",

                                    text: "Please select an avatar before voting!",

                                    icon: "warning"

                                });

                                return;

                            }



                            const answerId = button.getAttribute('data-answer-id');

                            fetch('/vote', {

                                method: 'POST',

                                headers: {

                                    'Content-Type': 'application/json'

                                },

                                body: JSON.stringify({

                                    answer_id: answerId,

                                    username: userName,

                                    avatar: selectedAvatar

                                })

                            }).then(response => response.json())

                                .then(data => {

                                    console.log('Vote submitted', data);

                                    Swal.fire({

                                        title: "Good job!",

                                        text: "Vote successful!",

                                        icon: "success"

                                    });

                                    loadAnswers();

                                });

                        });

                    });

                });

        }

        let targetMarker;

        socket.on('show_target_location', function(data) {
            if (playerMap) {
                const goldIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });

                if (targetMarker) playerMap.removeLayer(targetMarker);
                targetMarker = L.marker([data.lat, data.lon], {icon: goldIcon}).addTo(playerMap);
                //targetMarker.bindPopup("Correct Answer").openPopup();
            }
        });

        socket.on('next_question', function (data) {
            if (targetMarker && playerMap) {
                playerMap.removeLayer(targetMarker);
                targetMarker = null;
            }
            // 1. Render the new question structure
            renderQuestionUI(data.question);
            setupAnswerUI(data.question);
            renderImages(data.question.images);

            // 2. Clear inputs
            const container = document.getElementById('answerInputsContainer');
            if (container) {
                container.innerHTML = ''; 
                // For decreasing questions, we usually just need one input
                if (data.question.type === 'decreasing') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control form-control-lg mb-3 part-input';
                    input.placeholder = "Skriv svaret här...";
                    container.appendChild(input);
                } else if (data.question.parts) {
                    // Re-create inputs for parts
                    data.question.parts.forEach((part, index) => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'form-control form-control-lg mb-3 part-input';
                        input.placeholder = `Svar för fråga ${index + 1}...`;
                        container.appendChild(input);
                    });
                }
            }

            // 3. UI Resets
            document.getElementById('submitAnswer').disabled = false;
            localStorage.removeItem('hasVoted');
            loadAnswersAndVotes();
        });






        window.onload = loadAnswers;

      setInterval(loadAnswersAndVotes, 2000);



        function loadAnswersAndVotes() {

            fetch('/get_game_state')

                .then(response => response.json())

                .then(data => {

                    const answersList = document.getElementById('answers-list');

                    answersList.innerHTML = '';

                    answersList.style.display = 'flex';

                    answersList.style.flexWrap = 'wrap';



                    var userHasVoted = localStorage.getItem('hasVoted') === 'true';



                    let votesRevealed = data.reveal;



                    let sortedAnswers = [...data.answers];

                    sortedAnswers.sort((a, b) => b.random_num - a.random_num);



                    sortedAnswers.forEach(answer => {

                        if (!answer.visible) return;



                        var answerDiv = document.createElement('div');

                        answerDiv.classList.add('col-sm-12', 'col-md-12', 'col-12', 'col-lg-6', 'mb-4');

                        let displayHeader = "";
                        if (answer.potential_points !== undefined && answer.potential_points > 0) {
                            displayHeader = `<strong>${answer.potential_points}</strong>: ${answer.username}`;
                        } else {
                            displayHeader = `${answer.username}`;
                        }

                        answerDiv.innerHTML = `
                        <div class="card text-center">
                            <div class="card-body">
                                <img src="${answer.avatar}" alt="${answer.username}'s Avatar" class="rounded-circle answer-avatar" width="50" style="display: none;" data-bs-toggle="tooltip" title="${answer.username}">
                                <p class="card-text answer-text">
                                    <strong class="answer-name">${displayHeader}</strong> 
                                    ${Array.isArray(answer.text) ? answer.text.join(', ') : answer.text}
                                </p>
                                <div class="votes" id="votes-${answer.id}" style="display: ${votesRevealed ? 'block' : 'none'};">Votes: ${answer.votes.join(', ')}</div>
                            </div>                    
                        </div>
                    `;
                    answersList.appendChild(answerDiv);



                        if (answer.is_correct) {

                            answerDiv.classList.add('correct-answer');

                        }



                        if (votesRevealed) {

                            const answerCard = answerDiv.querySelector('.card-body');

                            answerCard.querySelector('.answer-avatar').style.display = 'inline-block';

                            answerCard.querySelector('.answer-name').style.display = 'inline';



                            const voteDiv = document.getElementById(`votes-${answer.id}`);

                            voteDiv.style.display = 'block';

                            voteDiv.innerHTML = `Votes: ${answer.votes.map(vote => {

                                // Add the title attribute for the tooltip

                                return `<img src="${vote.avatar}" class="rounded-circle" width="30" alt="avatar" title="${vote.username}">`;

                            }).join(' ')}`;

                        }



                        document.querySelectorAll('.vote-btn').forEach(function (button) {

                            button.addEventListener('click', function () {

                                if (!userName) {

                                    Swal.fire({

                                        title: "Oops!",

                                        text: "Please enter your name before voting!",

                                        icon: "warning"

                                    });

                                    return;

                                }

                                if (!selectedAvatar) {

                                    Swal.fire({

                                        title: "Oops!",

                                        text: "Please select an avatar before voting!",

                                        icon: "warning"

                                    });

                                    return;

                                }



                                var answerId = button.getAttribute('data-answer-id');

                                fetch('/vote', {

                                    method: 'POST',

                                    headers: {

                                        'Content-Type': 'application/json'

                                    },

                                    body: JSON.stringify({

                                        answer_id: answerId,

                                        username: userName,

                                        avatar: selectedAvatar

                                    })

                                }).then(response => response.json())

                                    .then(data => {

                                        console.log('Vote submitted', data);

                                        Swal.fire({

                                            title: "Good job!",

                                            text: "Vote successful!",

                                            icon: "success"

                                        });

                                        localStorage.setItem('hasVoted', 'true');

                                        loadAnswersAndVotes();

                                    });

                            });

                        });

                    });



                    if (data.canRevealVotes) {

                        document.getElementById('revealVotes').style.display = 'block';

                    }

                });

        }



        socket.on('reveal_votes', function (data) {

            if (data.reveal) {

                data.answers.forEach(answer => {

                    const answerCard = document.getElementById('answer-' + answer.id);



                    answerCard.querySelector('.answer-text').textContent = answer.text;

                    answerCard.querySelector('.answer-avatar').src = answer.avatar;

                    answerCard.querySelector('.votes-list').textContent = 'Voted by: ' + (answer.votes

                        .length > 0 ? answer.votes.join(", ") : "No one");

                });

            }

        });

        socket.on('clue_update', function(data) {
            const questionTextElement = document.getElementById('question-text');
            const clueDiv = document.createElement('div');
            clueDiv.className = 'alert alert-info mt-2';
            clueDiv.innerText = `${10 - data.clue_index*2}: ${data.clue}`;
            questionTextElement.appendChild(clueDiv);
            
            // Track current points locally for the UI
            currentPointsAvailable = 5 - data.clue_index;
        });

        socket.on('update_answers', function (data) {

            data.answers.forEach(answer => {

                const answerCard = document.getElementById('answer-' + answer.id);

                if (answer.visible) {

                    answerCard.style.display = 'block';

                } else {

                    answerCard.style.display = 'none';

                }

            });

        });


    document.getElementById('submitAnswer').addEventListener('click', function () {
    let finalAnswer;

    // Check if we are in Map Mode
    if (currentQuestionType === 'map') {
        if (!playerMarker) {
            Swal.fire({ title: "Wait!", text: "You need to place a marker on the map first!", icon: "warning" });
            return;
        }
        // Get the lat/lng from the Leaflet marker
        const position = playerMarker.getLatLng();
        finalAnswer = { lat: position.lat, lon: position.lng };
    } else {
        // Handle standard or multi-part questions
        const inputs = document.querySelectorAll('.part-input');
        finalAnswer = Array.from(inputs).map(input => input.value);
        
        if (finalAnswer.length === 0 || (finalAnswer.length === 1 && !finalAnswer[0].trim())) {
            Swal.fire({ title: "Oops!", text: "Please enter an answer!", icon: "warning" });
            return;
        }
    }

    // Send the data to the server
    fetch('/submit_answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            answer: finalAnswer,
            username: userId,
            question_id: currentQuestionId,
            avatar: selectedAvatar
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({ title: "Submitted!", text: "Your guess has been recorded.", icon: "success" });
            document.getElementById('submitAnswer').disabled = true;
            
            // Disable map interaction after submission
            if (playerMap) {
                playerMap.dragging.disable();
                playerMap.touchZoom.disable();
                playerMap.doubleClickZoom.disable();
                playerMap.scrollWheelZoom.disable();
            }
        }
    });
});



        function handleVoteButtonClick(answerId) {

            fetch('/vote', {

                method: 'POST',

                headers: {

                    'Content-Type': 'application/json'

                },

                body: JSON.stringify({

                    answer_id: answerId,

                    username: userName,

                    avatar: selectedAvatar

                })

            }).then(response => response.json())

                .then(data => {

                    Swal.fire({

                        title: "Good job!",

                        text: "You voted for answer ID: " + answerId,

                        icon: "success"

                    });



                    document.querySelector(`[data-answer-id="${answerId}"]`).disabled = true;

                });

        }



        function addVoteListeners() {

            document.querySelectorAll('.vote-btn').forEach(function (button) {

                button.addEventListener('click', function () {

                    var answerId = button.getAttribute('data-answer-id');

                    handleVoteButtonClick(answerId);

                });

            });

        }



        addVoteListeners();



        function loadCurrentQuestion() {
            fetch('/get_game_state')
                .then(response => response.json())
                .then(data => {
                    const questionTextElement = document.getElementById('question-text');
                    if (data.current_question) {
                        // Use the rendering helper to set up the text and clues
                        renderQuestionUI(data.current_question);
                        renderImages(data.current_question.images);
                        // Set up the correct number of input boxes immediately
                        setupAnswerInputs(data.current_question);
                        
                        // Store the ID for the submit button
                        currentQuestionId = data.current_question.id; 
                    } else {
                        questionTextElement.innerText = "No question selected.";
                    }
                });
        }

        function setupAnswerUI(question) {
    currentQuestionType = question.type;
    currentQuestionId = question.id;
    
    const inputContainer = document.getElementById('answerInputsContainer');
    const mapContainer = document.getElementById('map-container');
    const label = document.getElementById('answer-label');

    // Reset Submit Button
    document.getElementById('submitAnswer').disabled = false;

    if (question.type === 'map') {
        if (inputContainer) inputContainer.style.display = 'none';
        if (mapContainer) mapContainer.style.display = 'block';
        if (label) label.innerText = "Click the map to place your marker:";
        
        if (playerMarker && playerMap) {
            playerMap.removeLayer(playerMarker);
            playerMarker = null;
        }

        setTimeout(() => {
            initMap();
            playerMap.invalidateSize();
            playerMap.setView([20, 0], 2);
        }, 300);
    } 
    else {
        // Switch to Text Mode
        if (inputContainer) inputContainer.style.display = 'block';
        if (mapContainer) mapContainer.style.display = 'none';
        if (label) label.innerText = "Your Answer(s):";
        
        // Rebuild the input boxes for parts/standard
        setupAnswerInputs(question);
    }
}

        function setupAnswerInputs(question) {
            const container = document.getElementById('answerInputsContainer');
            if (!container) return;

            container.innerHTML = ''; // Clear old inputs

            if (question.type === 'decreasing') {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control form-control-lg mb-3 part-input';
                input.placeholder = "Enter your guess...";
                container.appendChild(input);
            } 
            else if (question.parts && question.parts.length > 0) {
                // Handle multi-part questions
                question.parts.forEach((part, index) => {
                    const label = document.createElement('p');
                    label.className = 'text-muted small mb-1 mt-2';
                    label.innerText = `Part ${index + 1}: ${part}`;
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control form-control-lg mb-3 part-input';
                    input.placeholder = `Your answer for part ${index + 1}...`;
                    
                    container.appendChild(label);
                    container.appendChild(input);
                });
            } 
            else {
                // Standard single question
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control form-control-lg mb-3 part-input';
                input.placeholder = "Enter your answer...";
                container.appendChild(input);
            }
        }

// In game.html
        function renderQuestionUI(question) {
            currentQuestionType = question.type; // Set the global type here
            currentQuestionId = question.id;
            const questionTextElement = document.getElementById('question-text');
            questionTextElement.innerHTML = ''; 

            // Show Question Name/Title if available
            if (question.name) {
                const title = document.createElement('h3');
                title.innerText = question.name;
                title.className = "mb-3";
                questionTextElement.appendChild(title);
            }

            if (question.type === 'map') {
                document.getElementById('map-container').style.display = 'block';
                document.getElementById('answerInputsContainer').style.display = 'none'; // Hide text box
                setTimeout(() => { initMap(); playerMap.invalidateSize(); }, 200);
            } else {
                document.getElementById('map-container').style.display = 'none';
                document.getElementById('answerInputsContainer').style.display = 'block';
            }

            if (question.type === 'decreasing') {
                // Ensure we have a valid index
                const currentIndex = question.current_clue_index !== undefined ? question.current_clue_index : 0;
                
                // Loop through all revealed clues
                for (let i = 0; i <= currentIndex; i++) {
                    if (question.clues && question.clues[i]) {
                        const clue = document.createElement('p');
                        clue.className = 'alert alert-info w-100';
                        clue.innerText = `${10 - i*2}: ${question.clues[i]}`;
                        questionTextElement.appendChild(clue);
                    }
                }
            } else if (question.parts) {
                // Handle multi-part questions
                question.parts.forEach((part, index) => {
                    const p = document.createElement('p');
                    p.innerText = `${index + 1}. ${part}`;
                    questionTextElement.appendChild(p);
                });
            } else {
                // Fallback for standard text questions
                questionTextElement.innerText = question.text || "New question started!";
            }
        }



        window.onload = function () {

            localStorage.removeItem('hasVoted');

            fetchUsers(); // Initial call

            setInterval(fetchUsers, 2000);

            loadCurrentQuestion();

            loadAnswersAndVotes();

           setInterval(loadAnswersAndVotes, 2000);

        };

    </script>



    <script>

        const socket = io.connect('http://localhost:5000');



        socket.on('next_question_cleared', () => {

            document.getElementById('answers').innerHTML = '';

            console.log("Cleared answers and votes for the next question");

            Swal.fire({

                title: "Get ready!",

                text: "Get ready for the next question!",

                icon: "info",

                confirmButtonText: "Next"

            });

        });

    </script>



    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

</body>



</html>
